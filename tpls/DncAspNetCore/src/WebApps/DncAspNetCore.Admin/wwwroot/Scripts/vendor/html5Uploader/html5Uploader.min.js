(function(n){function t(t,i){function w(){if(i=n.extend({},p,i),o=n(t).addClass("up-container"),o.length){r=o.find("ul.up-pics");r.length||(r=n('<ul class="up-pics"><\/ul>').appendTo(o));f=n('<input type="file" class="up-file" accept="image/*" />').appendTo(o);i.uploadLimit>1&&f.attr("multiple","multiple");f.wrap('<div class="up-entry"><\/div>').change(function(){this.files&&this.files.length&&(a=Math.random(),h=this.files,s=h.length,v(0))});r.on("tap","a.up-del",function(){n(this).closest("li.up-pic").remove();e()});r.on("click","a.up-del",function(){n(this).closest("li.up-pic").remove();e()});e()}}function v(n){if(n>=h.length){f.val("");return}b(h[n],function(){v(++n)})}function b(t,f){function w(){var n=new FileReader;n.onloadend=function(){if(n.error){alert("文件获取失败！");o.remove();f&&f.call();return}var t=n.result;o.find(".pos").animate({width:"30%"},2500,"linear");o.find("img").attr({src:t,onload:c});i.enableScale?b(t):p(t)};n.readAsDataURL(t)}function b(n){var t=new Image;t.onload=function(){var t=this.naturalWidth,r=this.naturalHeight,n,e,f,o;if(r>i.maxHeight&&(t*=i.maxHeight/r,r=i.maxHeight),t>i.maxWidth&&(r*=i.maxWidth/t,t=i.maxWidth),this.width=t,this.height=r,n=document.createElement("canvas"),e=n.getContext("2d"),n.width=t,n.height=r,e.drawImage(this,0,0,t,r),f=null,navigator.userAgent.match(/iphone/i)){if(h!=""&&h!=1)switch(h){case 6:u(this,"right",n);break;case 8:u(this,"left",n);break;case 3:u(this,"left",n);u(this,"left",n)}f=n.toDataURL("image/jpeg",.9)}else if(navigator.userAgent.match(/Android/i)&&!1)o=new JPEGEncoder,f=o.encode(e.getImageData(0,0,expectWidth,expectHeight),80);else{if(h!=""&&h!=1)switch(h){case 6:u(this,"right",n);break;case 8:u(this,"left",n);break;case 3:u(this,"left",n);u(this,"left",n)}f=n.toDataURL("image/jpeg",.9)}p(f)};t.src=n}function p(t){if(i.asyncUpload&&i.uploadUrl){var r=n.extend(i.postData,{fileName:v,data:t,count:s,uploadVerNo:a});n.post(i.uploadUrl,r,function(n){if(!n.success){alert(n.message);o.remove();f&&f.call();return}o.find("img").attr({src:n.src,onload:c});o.find(".pos").animate({width:"100%"},1e3,"linear",function(){o.addClass("up-over");e();f&&f.call()})},"json")}else o.find("img").attr({src:t,onload:c}),o.find(".pos").animate({width:"100%"},1e3,"linear",function(){o.addClass("up-over");e();f&&f.call()})}var h,v,o;if(!t.type.match(/image.*/)){alert("只能选择图片文件.");s--;f&&f.call();return}if(t.size>i.sizeLimit*1048576){alert("图片最大不能超过"+i.sizeLimit+"M.");s--;f&&f.call();return}if(y()){alert("最多只能上传"+i.uploadLimit+"个文件.");s=i.uploadLimit;f&&f.call();return}h=null;i.enableScale&&EXIF.getData(t,function(){EXIF.getAllTags(this);h=EXIF.getTag(this,"Orientation")});v=t.name;o=n(l).appendTo(r);w()}function u(n,t,i){var o,e;if(n!=null){var s=0,h=3,f=2,r=n.height,u=n.width;t=="left"?(f++,f>h&&(f=s)):(f--,f<s&&(f=h));o=f*90*Math.PI/180;e=i.getContext("2d");switch(f){case 0:i.width=u;i.height=r;e.drawImage(n,0,0,u,r);break;case 1:i.width=r;i.height=u;e.rotate(o);e.drawImage(n,0,-r,u,r);break;case 2:i.width=u;i.height=r;e.rotate(o);e.drawImage(n,-u,-r,u,r);break;case 3:i.width=r;i.height=u;e.rotate(o);e.drawImage(n,-u,0,u,r)}}}function c(){var n=this.parentNode,t,i;n&&(t=this.offsetHeight-n.offsetHeight,i=this.offsetWidth-n.offsetWidth,0>t&&(this.style.width="auto",this.style.height="100%"),0>i&&(this.style.height="auto",this.style.width="100%"))}function e(){y()?f.parent().hide():f.parent().show()}function y(){return i.uploadLimit>0&&r.children().length>=i.uploadLimit}function k(){var t=[];return r.find(".up-over img").each(function(){t.push(n(this).attr("src"))}),t}function d(t){var i=n(l).appendTo(r);i.addClass("up-over");i.find("img").attr({src:t,onload:c});e()}function g(){r.empty()}var p={enableScale:!0,asyncUpload:!1,uploadUrl:null,maxHeight:800,maxWidth:800,uploadLimit:5,sizeLimit:5,postData:null},l='<li class="up-pic"><div class="up-clip"><img src="" style="display:block;" /><\/div><div class="up-mask"><\/div><div class="up-progress"><div class="pos"><\/div><\/div><a class="up-del" href="javascript:void(0)" title="关闭">&nbsp;<\/a><\/li>',o,r,f,h,s=0,a;return w(),{getUploadFiles:k,insertItem:d,clear:g}}n.extend(window,{Html5Uploader:t})})(jQuery);